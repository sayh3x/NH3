# ฺฉุชุงุจุฎุงูู MEMS_NH3 ุจุฑุง Arduino

ฺฉุชุงุจุฎุงูู ุญุฑููโุง ู ุฏูู ุจุฑุง ุชุดุฎุต ฺฏุงุฒ ุขูููุงฺฉ (NHโ) ุจุง ุณูุณูุฑ **DFRobot SEN0567** ู **NodeMCU (ESP8266)**

## ๐ ูฺฺฏโูุง ฺฉูุฏ

- โ **ฺฉุงูุจุฑุงุณูู ุฎูุฏฺฉุงุฑ R0** ุจุง ุงูฺฏูุฑุชู ููุดููุฏ
- โ **ููุชุฑ Kalman** ุจุฑุง ุญุฐู ููุฒ ู ุฏูุช ุจุงูุง
- โ **ุชุตุญุญ ุฏูุง ู ุฑุทูุจุช** ุจุฑุง ุดุฑุงุท ูุญุท ูุชุบุฑ
- โ **ูุฏุฑุช ฺฏุฑูโฺฉุฑุฏู ุณูุณูุฑ** (5 ุฏููู ุงููู)
- โ **ุณุณุชู ูุดุฏุงุฑ 4 ุณุทุญ** (SAFE, CAUTION, WARNING, DANGER)
- โ **ูุญุงุณุจู TWA** (Time Weighted Average) ุจุฑุง ุงูู ุตูุนุช
- โ **ุฐุฎุฑู R0 ุฏุฑ EEPROM** ุจุฑุง ุญูุธ ฺฉุงูุจุฑุงุณูู
- โ **ุฎุฑูุฌ JSON** ุจุฑุง IoT ู ุงุฑุณุงู ุจู ุณุฑูุฑ
- โ **ุชุดุฎุต ูุงุฒ ุจู ฺฉุงูุจุฑุงุณูู ูุฌุฏุฏ** (ูุฑ 30 ุฑูุฒ)

---

## ๐ฆ ูุตุจ ฺฉุชุงุจุฎุงูู

### ุฑูุด 1: ูุตุจ ุฏุณุช
1. ูุงูโูุง `MEMS_NH3.h` ู `MEMS_NH3.cpp` ุฑุง ุฏุฑ ูพูุดู ุฒุฑ ฺฉูพ ฺฉูุฏ:
   ```
   Arduino/libraries/MEMS_NH3/
   ```

2. Arduino IDE ุฑุง ุฑุณุชุงุฑุช ฺฉูุฏ

### ุฑูุด 2: ุงุฒ ุทุฑู GitHub
```bash
cd ~/Documents/Arduino/libraries
git clone https://github.com/yourusername/MEMS_NH3.git
```

---

## ๐ ุงุชุตุงูุงุช ุณุฎุชโุงูุฒุงุฑ

### ุณูุณูุฑ SEN0567 ุจู NodeMCU

| ุณูุณูุฑ SEN0567 | NodeMCU |
|---------------|---------|
| VCC (3.3V)    | 3V3     |
| GND           | GND     |
| OUT (Analog)  | A0      |

### (ุงุฎุชุงุฑ) ุณูุณูุฑ ุฏูุง/ุฑุทูุจุช DHT22

| DHT22 | NodeMCU |
|-------|---------|
| VCC   | 3V3     |
| GND   | GND     |
| DATA  | D4      |

---

## ๐ก ุงุณุชูุงุฏู ุณุฑุน

### ูุซุงู ุณุงุฏู

```cpp
#include "MEMS_NH3.h"

MEMS_NH3 sensor(A0, 4700, 3.3, -1.53, 1.35);

void setup() {
  Serial.begin(115200);
  sensor.begin();
  
  if (!sensor.isCalibrated()) {
    sensor.calibrateR0(100, 100);
  }
}

void loop() {
  if (sensor.isWarmedUp()) {
    float ppm = sensor.getPPM();
    
    Serial.print("NH3: ");
    Serial.print(ppm);
    Serial.println(" ppm");
  }
  
  delay(2000);
}
```

---

## ๐ API Reference

### ุณุงุฎุช ู ุฑุงูโุงูุฏุงุฒ

#### `MEMS_NH3(int adcPin, float rl, float vcc, float a, float b)`
ุณุงุฒูุฏู ฺฉูุงุณ

**ูพุงุฑุงูุชุฑูุง:**
- `adcPin`: ูพู ุขูุงููฺฏ (A0)
- `rl`: ููุงููุช ุจุงุฑ (ูพุดโูุฑุถ: 4700ฮฉ)
- `vcc`: ููุชุงฺ ุชุบุฐู (ูพุดโูุฑุถ: 3.3V)
- `a`: ุถุฑุจ ูฺฏุงุฑุชู (ูพุดโูุฑุถ: -1.53)
- `b`: ุถุฑุจ ุซุงุจุช (ูพุดโูุฑุถ: 1.35)

#### `void begin()`
ุฑุงูโุงูุฏุงุฒ ุณูุณูุฑ ู ุจุงุฑฺฏุฐุงุฑ R0 ุงุฒ EEPROM

---

### ฺฉุงูุจุฑุงุณูู

#### `void calibrateR0(int samples, int delayMs)`
ฺฉุงูุจุฑุงุณูู ุฎูุฏฺฉุงุฑ R0 ุฏุฑ ููุง ูพุงฺฉ

**ูพุงุฑุงูุชุฑูุง:**
- `samples`: ุชุนุฏุงุฏ ููููู (ูพุดโูุฑุถ: 100)
- `delayMs`: ุชุงุฎุฑ ุจู ูููููโูุง (ูพุดโูุฑุถ: 100ms)

**ูฺฉุชู ููู:** ุณูุณูุฑ ุจุงุฏ ุฏุฑ **ููุง ูพุงฺฉ** (ุจุฏูู NHโ) ูุฑุงุฑ ุฏุงุดุชู ุจุงุดุฏ

#### `bool isCalibrated()`
ุจุฑุฑุณ ฺฉุงูุจุฑู ุจูุฏู ุณูุณูุฑ

#### `bool needsRecalibration()`
ุจุฑุฑุณ ูุงุฒ ุจู ฺฉุงูุจุฑุงุณูู ูุฌุฏุฏ (ุจุนุฏ ุงุฒ 30 ุฑูุฒ)

---

### ุฎูุงูุฏู ุฏุงุฏูโูุง

#### `float getPPM(bool useFilter = true)`
ุฎูุงูุฏู ุบูุธุช NHโ ุจู ppm

**ุจุงุฒฺฏุดุช:**
- ููุฏุงุฑ ppm ุง `NAN` ุฏุฑ ุตูุฑุช ุฎุทุง

#### `float getRs()`
ุฎูุงูุฏู ููุงููุช ุณูุณูุฑ (Rs) ุจู ุงูู

#### `float getRatio()`
ุฎูุงูุฏู ูุณุจุช Rs/R0

#### `float getR0()`
ุฎูุงูุฏู ููุงููุช ูุฑุฌุน (R0)

#### `float getVnode()`
ุฎูุงูุฏู ููุชุงฺ ุฎุฑูุฌ ุณูุณูุฑ

---

### ูุฏุฑุช R0

#### `void saveR0()`
ุฐุฎุฑู R0 ุฏุฑ EEPROM

#### `bool loadR0()`
ุจุงุฑฺฏุฐุงุฑ R0 ุงุฒ EEPROM

#### `void setR0(float r0)`
ุชูุธู ุฏุณุช R0

---

### ูุถุนุช ุณูุณูุฑ

#### `bool isWarmedUp()`
ุจุฑุฑุณ ฺฏุฑู ุดุฏู ฺฉุงูู ุณูุณูุฑ (5 ุฏููู)

#### `bool isValid()`
ุจุฑุฑุณ ูุนุชุจุฑ ุจูุฏู ุขุฎุฑู ุฎูุงูุฏู

#### `unsigned long getWarmupRemaining()`
ุฒูุงู ุจุงูโูุงูุฏู ุชุง ฺฏุฑู ุดุฏู (ุจู ููโุซุงูู)

---

### ุชุตุญุญ ูุญุท

#### `void setTempHumidityCorrection(float temp, float humidity)`
ุชูุธู ุฏูุง ู ุฑุทูุจุช ูุนู

**ูพุงุฑุงูุชุฑูุง:**
- `temp`: ุฏูุง ุจู ุฏุฑุฌู ุณุงูุชโฺฏุฑุงุฏ
- `humidity`: ุฑุทูุจุช ุจู ุฏุฑุตุฏ

#### `void enableTempHumidityCorrection(bool enable)`
ูุนุงู/ุบุฑูุนุงู ฺฉุฑุฏู ุชุตุญุญ ูุญุท

#### `void setTempCoeff(float kT)`
ุชูุธู ุถุฑุจ ุชุตุญุญ ุฏูุง (ูพุดโูุฑุถ: 0.01)

#### `void setHumidityCoeff(float kH)`
ุชูุธู ุถุฑุจ ุชุตุญุญ ุฑุทูุจุช (ูพุดโูุฑุถ: 0.005)

---

### ููุชุฑ

#### `void enableKalmanFilter(bool enable)`
ูุนุงู/ุบุฑูุนุงู ฺฉุฑุฏู ููุชุฑ Kalman

#### `void resetKalmanFilter()`
ุฑุณุช ฺฉุฑุฏู ููุชุฑ Kalman

---

### ุณุทุญ ูุดุฏุงุฑ

#### `AlertLevel getAlertLevel()`
ุฏุฑุงูุช ุณุทุญ ูุดุฏุงุฑ

**ุจุงุฒฺฏุดุช:**
- `SAFE`: < 25 ppm
- `CAUTION`: 25-50 ppm
- `WARNING`: 50-100 ppm
- `DANGER`: > 100 ppm

#### `const char* getAlertString()`
ุฏุฑุงูุช ูุชู ุณุทุญ ูุดุฏุงุฑ

---

### TWA (Time Weighted Average)

#### `void updateTWA()`
ุจูโุฑูุฒุฑุณุงู ูุญุงุณุจู TWA

#### `float getTWA()`
ุฏุฑุงูุช ููุฏุงุฑ TWA ูุนู

#### `void resetTWA()`
ุฑุณุช ฺฉุฑุฏู TWA

---

### JSON Output

#### `String toJSON()`
ุฏุฑุงูุช ุฎุฑูุฌ JSON ุดุงูู ุชูุงู ูพุงุฑุงูุชุฑูุง

**ุฎุฑูุฌ ููููู:**
```json
{
  "ppm": 35.67,
  "rs": 12450.00,
  "r0": 25000.00,
  "ratio": 0.498,
  "alert": "CAUTION",
  "twa": 32.15,
  "warmed_up": true,
  "calibrated": true,
  "timestamp": 123456
}
```

---

### ุชูุธูุงุช

#### `void setCoefficients(float a, float b)`
ุชูุธู ุถุฑุงุจ ูฺฏุงุฑุชู

#### `void setRL(float rl)`
ุชูุธู ููุงููุช ุจุงุฑ

#### `void setVcc(float vcc)`
ุชูุธู ููุชุงฺ ุชุบุฐู

---

## ๐ฌ ูุญูู ูุญุงุณุจุงุช

### 1. ูุญุงุณุจู ููุงููุช ุณูุณูุฑ (Rs)

```
Rs = RL ร (Vcc / Vnode - 1)
```

### 2. ูุญุงุณุจู ูุณุจุช

```
Ratio = Rs / R0
```

### 3. ุชุจุฏู ุจู PPM

```
logโโ(ppm) = a ร logโโ(ratio) + b
ppm = 10^(a ร logโโ(ratio) + b)
```

### 4. ุชุตุญุญ ูุญุท

```
Rs_corrected = Rs ร (1 + kTร(T-25) + kHร(H-50))
```

---

## ๐ ฺฉุงูุจุฑุงุณูู ุฏูู

ุจุฑุง ุฏูุช ุจุดุชุฑุ ูโุชูุงูุฏ ุถุฑุงุจ `a` ู `b` ุฑุง ุจุง ุฏู ููุทู ูุนููู ูุญุงุณุจู ฺฉูุฏ:

```cpp
// ูุซุงู: ratio1=0.6 โ 10ppm, ratio2=0.15 โ 100ppm
float a = (log10(100) - log10(10)) / (log10(0.15) - log10(0.6));
// a โ -1.53

float b = log10(10) - a * log10(0.6);
// b โ 1.35

sensor.setCoefficients(a, b);
```

---

## โ๏ธ ูฺฉุงุช ููู

### ฺฏุฑูโฺฉุฑุฏู ุณูุณูุฑ
- **ุงููู ุงุณุชูุงุฏู:** 24 ุณุงุนุช ฺฏุฑูโฺฉุฑุฏู ุชูุตู ูโุดูุฏ
- **ุงุณุชูุงุฏูโูุง ุจุนุฏ:** ุญุฏุงูู 5 ุฏููู

### ฺฉุงูุจุฑุงุณูู
- ููุดู ุฏุฑ **ููุง ูพุงฺฉ** ุงูุฌุงู ุดูุฏ
- ุฏูุฑ ุงุฒ ููุงุจุน NHโ (ุณุฑูุณ ุจูุฏุงุดุชุ ููุงุฏ ุดูุง)
- ุฏุฑ ุฏูุง ุงุชุงู (20-25ยฐC)

### ูุญุฏูุฏูโูุง ูุนุชุจุฑ
- **Rs:** 100ฮฉ ุชุง 1Mฮฉ
- **R0:** 100ฮฉ ุชุง 500kฮฉ
- **PPM:** 0 ุชุง 1000 ppm

### ุฏูุช
- ุจุง ููุชุฑ Kalman: ยฑ5 ppm
- ุจุฏูู ููุชุฑ: ยฑ10 ppm
- ุจุง ุชุตุญุญ ุฏูุง/ุฑุทูุจุช: ยฑ3 ppm

---

## ๐๏ธ ุนุจโุงุจ

### ูุดฺฉู: `getPPM()` ููุดู `NAN` ุจุฑูโฺฏุฑุฏุงูุฏ

**ุฑุงูโุญู:**
1. ุจุฑุฑุณ ุงุชุตุงูุงุช
2. ฺฺฉ ฺฉุฑุฏู `isWarmedUp()`
3. ฺฉุงูุจุฑุงุณูู ูุฌุฏุฏ
4. ุจุฑุฑุณ ููุชุงฺ ุชุบุฐู (ุจุงุฏ ุฏููุงู 3.3V ุจุงุดุฏ)

### ูุดฺฉู: ููุงุฏุฑ ูุงูพุงุฏุงุฑ

**ุฑุงูโุญู:**
1. ูุนุงู ฺฉุฑุฏู ููุชุฑ Kalman
2. ุงูุฒุงุด ุชุนุฏุงุฏ ูููููโูุง ุฏุฑ ูุงูฺฏูโฺฏุฑ
3. ุงุณุชูุงุฏู ุงุฒ ุชุตุญุญ ุฏูุง/ุฑุทูุจุช

### ูุดฺฉู: R0 ุฐุฎุฑู ููโุดูุฏ

**ุฑุงูโุญู:**
1. ุจุฑุฑุณ `EEPROM.begin(512)` ุฏุฑ `setup()`
2. ุจุฑุฑุณ ูุถุง ฺฉุงู EEPROM
3. ูุฑุงุฎูุงู `EEPROM.commit()` ุจุนุฏ ุงุฒ write

---

## ๐ ูุซุงูโูุง ูพุดุฑูุชู

### ุงุชุตุงู ุจู WiFi ู ุงุฑุณุงู ุจู ThingSpeak

```cpp
#include <ESP8266WiFi.h>
#include "MEMS_NH3.h"

const char* ssid = "YourWiFi";
const char* password = "YourPassword";
const char* server = "api.thingspeak.com";
String apiKey = "YOUR_API_KEY";

MEMS_NH3 sensor(A0);

void setup() {
  Serial.begin(115200);
  sensor.begin();
  
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }
}

void loop() {
  if (sensor.isWarmedUp()) {
    float ppm = sensor.getPPM();
    
    if (!isnan(ppm)) {
      sendToThingSpeak(ppm);
    }
  }
  
  delay(60000); // ูุฑ 1 ุฏููู
}

void sendToThingSpeak(float ppm) {
  WiFiClient client;
  
  if (client.connect(server, 80)) {
    String postStr = apiKey;
    postStr += "&field1=";
    postStr += String(ppm);
    postStr += "\r\n\r\n";
    
    client.print("POST /update HTTP/1.1\n");
    client.print("Host: api.thingspeak.com\n");
    client.print("Connection: close\n");
    client.print("X-THINGSPEAKAPIKEY: " + apiKey + "\n");
    client.print("Content-Type: application/x-www-form-urlencoded\n");
    client.print("Content-Length: ");
    client.print(postStr.length());
    client.print("\n\n");
    client.print(postStr);
  }
  client.stop();
}
```

---

## ๐ ูุฑุงุฌุน

- [ุฏุชุงุดุช SEN0567](https://wiki.dfrobot.com/SKU_SEN0567)
- [ุฏุงฺฉูููุช ESP8266](https://arduino-esp8266.readthedocs.io/)
- [ุงุณุชุงูุฏุงุฑุฏูุง ุงูู NHโ](https://www.osha.gov/)

---

## ๐ค ูุดุงุฑฺฉุช

ุจุฑุง ูุดุงุฑฺฉุช ุฏุฑ ุชูุณุนู ุงู ฺฉุชุงุจุฎุงูู:
1. Fork ฺฉูุฏ
2. ฺฉ branch ุฌุฏุฏ ุจุณุงุฒุฏ
3. ุชุบุฑุงุช ุฑุง commit ฺฉูุฏ
4. Pull request ุงุฑุณุงู ฺฉูุฏ

---

## ๐ License

ุงู ฺฉุชุงุจุฎุงูู ุชุญุช ูุงุณูุณ MIT ููุชุดุฑ ุดุฏู ุงุณุช.

---

## ๐จโ๐ป ุณุงุฒูุฏู

ุณุงุฎุชู ุดุฏู ุจุฑุง ุฌุงูุนู Arduino ู IoT ุงุฑุงู ๐ฎ๐ท

**ูุณุฎู:** 1.0.0  

---

## ๐ฌ ูพุดุชุจุงู

ุจุฑุง ุณูุงูุงุช ู ูุดฺฉูุงุช:
- GitHub Issues
**ูููู ุจุงุดุฏ! ๐**
